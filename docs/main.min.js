function getRandomColor(){for(var e="0123456789ABCDEF",t="0x",n=0;n<6;n++)t+=e[Math.floor(16*Math.random())];return t}function getCountPixels(e){for(var t=e.length/3,n=0,i=0;i<t;i++)n+=e[3*i]||e[3*i+1]||e[3*i+2]?1:0;return n}function Factory(){var e=50,t={x:0,y:0};this.getCircle=function(){var n=[{name:"drawCircle",parameters:[t.x,t.y]}],i=e,s=Math.round((1+Math.random())*i);return n[0].parameters.push(s),n},this.getEllipse=function(){var n=[{name:"drawEllipse",parameters:[t.x,t.y]}],i=e,s=Math.round((1+Math.random())*i),r=Math.round((1+Math.random())*i);return n[0].parameters.push(s),n[0].parameters.push(r),n},this.getNSide=function(){var n=[{name:"moveTo",parameters:[t.x,t.y]}],i=3+Math.floor(4*Math.random()),s=2*Math.PI/i,r=new Array,a=2*e,h={x:t.x,y:t.y};r.push({x:t.x,y:t.y});for(var o=1;o<i;o++){var c=s*o,l=a*Math.sin(s/2)*(Math.random()-.5),d=Math.round(r[o-1].x+a*Math.cos(c)+l),p=Math.round(r[o-1].y+a*Math.sin(c)+l);r.push({x:d,y:p}),n.push({name:"lineTo",parameters:[d,p]})}return n.push({name:"lineTo",parameters:[h.x,h.y]}),n.push({name:"endFill",parameters:null}),n},this.getNSideArc=function(){var n=[{name:"moveTo",parameters:[t.x,t.y]}],i=4+Math.floor(4*Math.random()),s=2*Math.PI/i,r=new Array,a=2*e,h={x:t.x,y:t.y};r.push({x:t.x,y:t.y});for(var o=1;o<i;o++){var c=s*o,l=2*a*Math.sin(s/2)*(Math.random()-.5),d=Math.round(r[o-1].x+a*Math.cos(c)),p=Math.round(r[o-1].y+a*Math.sin(c)),u=Math.round(r[o-1].x+a*Math.cos(c)+l),m=Math.round(r[o-1].y+a*Math.sin(c)+l);r.push({x:u,y:m}),n.push({name:"bezierCurveTo",parameters:[r[o-1].x,r[o-1].y,d,p,u,m]})}return n.push({name:"bezierCurveTo",parameters:[r[i-1].x,r[i-1].y,d,p,h.x,h.y]}),n.push({name:"endFill",parameters:null}),n}}function ShapesPool(){this.elementFactory=new Factory,this.createShapes()}ShapesPool.prototype.borrowShape=function(){return this.shapes.shift()},ShapesPool.prototype.returnShape=function(e){this.shapes.push(e)},ShapesPool.prototype.createShapes=function(){this.shapes=[],this.addShapes(250,0),this.addShapes(250,1),this.addShapes(250,2),this.addShapes(250,3),this.shuffle(this.shapes)},ShapesPool.prototype.addShapes=function(e,t){for(var n,i=0;i<e;i++){switch(t){case 0:n=this.elementFactory.getCircle();break;case 1:n=this.elementFactory.getEllipse();break;case 2:n=this.elementFactory.getNSide();break;case 3:n=this.elementFactory.getNSideArc()}var s=new PIXI.Graphics;s.lineStyle(1,0,1),s.beginFill(getRandomColor());for(var r=0;r<n.length;r++){var a=n[r];s[a.name].apply(s,null!=a.parameters?a.parameters:null)}this.shapes.push(s)}},ShapesPool.prototype.shuffle=function(e){for(var t=e.length,n=3*t,i=0;i<n;i++){var s=e.pop(),r=Math.floor(Math.random()*(t-1));e.splice(r,0,s)}};var SceneView=function(e,t){function n(e){i.sendRequestToCreate(e)}var i=this;this.width=e,this.height=t,this.totalArea=0,this.currentWidth=e,this.currentHeight=t,this.scale=1,document.getElementById("decSPS").addEventListener("click",function(){i.updateNumberOfShapes(!1)}),document.getElementById("incSPS").addEventListener("click",function(){i.updateNumberOfShapes(!0)}),document.getElementById("decGravity").addEventListener("click",function(){i.updateGravity(!1)}),document.getElementById("incGravity").addEventListener("click",function(){i.updateGravity(!0)}),PIXI.utils.skipHello(),this.app=new PIXI.Application(e,t,{forceCanvas:PIXI.utils.isMobile.any}),document.getElementById("gameArea").appendChild(this.app.view),this.graphics=new PIXI.Graphics,this.countElements=0,this.BACKGROUND_COLOR=5869524,this.graphics.beginFill(this.BACKGROUND_COLOR,1),this.graphics.drawRect(0,0,e,t),this.app.stage.addChild(this.graphics),this.sendRequestToCreate=null,this.graphics.interactive=!0,this.graphics.buttonMode=!0,this.graphics.on("pointerdown",function(e){var t=e.data.getLocalPosition(i.app.stage);n({x:Math.round(t.x),y:Math.round(t.y)})}),this.elements=[]};SceneView.prototype.resize=function(){var e=1,t={width:window.innerWidth,height:window.innerHeight},n=document.getElementsByClassName("topInfo")[0].getBoundingClientRect().top,i=document.getElementsByClassName("bottomInfo")[0].getBoundingClientRect(),s=i.top+i.height,r=s-n,a=r-this.currentHeight;t.height<800&&(a=120*this.height/this.currentHeight);var h=this.width,o=this.height+a,c=1,l=1;c=t.width/h,l=t.height/o,e=l<c?l:c,this.currentWidth=this.width*e>this.width?this.width:this.width*e,this.currentHeight=this.height*e>this.height?this.height:this.height*e,this.app.view.style.width=this.currentWidth+"px",this.app.view.style.height=this.currentHeight+"px"},SceneView.prototype.updateNumberOfShapes=function(e){return e},SceneView.prototype.updateGravity=function(e){return e},SceneView.prototype.setNumberShapes=function(e){document.getElementById("numberOfShapes").innerHTML=e},SceneView.prototype.setShapesSurface=function(e){document.getElementById("surfaceOfShapes").innerHTML=e},SceneView.prototype.setShapesPerSec=function(e){document.getElementById("shapesPerSec").innerHTML=e},SceneView.prototype.setGravity=function(e){document.getElementById("gravity").innerHTML=e},SceneView.prototype.sendRequestToDestroy=function(e){return e},SceneView.prototype.sendRequestToCreate=function(){return!0},SceneView.prototype.countSurface=function(){this.setShapesSurface(this.totalArea)},SceneView.prototype.createElement=function(e){function t(){n.sendRequestToDestroy(this.index)}var n=this,i=e.element;i.interactive=!0,i.buttonMode=!0,i.index=e.index,i.on("pointerdown",t),this.elements[e.index]=i,this.app.stage.addChild(i),i.area||(i.area=getCountPixels(this.app.renderer.extract.pixels(i))),this.totalArea+=i.area},SceneView.prototype.updateView=function(e){for(var t in e)this.elements[t]||this.createElement(e[t]);for(var t in this.elements)e[t]?(this.elements[t].y=e[t].distance,this.elements[t].y+this.elements[t].height>10&&this.countElements++):(this.app.stage.removeChild(this.elements[t]),this.totalArea-=this.elements[t].area,delete this.elements[t]);this.setNumberShapes(this.countElements),this.countElements=0,this.countSurface()};var SceneModel=function(){var e=this;this.counterToCreate=0,this.acceleration=5,this.numberOfShapes=1,this.createNewElementCoords=null,this.indexToDestroy=null;var t=50;this.fieldSize={width:800,height:600},this.allowedStartCoords={minX:t,maxX:e.fieldSize.width-t,minY:-4*t,maxY:-5*t},this.pool=new ShapesPool,this.destroyElement=function(e){this.indexToDestroy=e},this.setCreateElementFlag=function(e){this.createNewElementCoords=e},this.setAcceleration=function(e,t){return t?this.acceleration:(e?this.acceleration++:this.acceleration=this.acceleration>1?this.acceleration-1:1,this.acceleration)},this.setNumOfShapes=function(e,t){return t?this.numberOfShapes:(e?this.numberOfShapes=this.numberOfShapes<500?this.numberOfShapes+1:500:this.numberOfShapes=this.numberOfShapes>1?this.numberOfShapes-1:1,this.numberOfShapes)},this.newScene={},this.createRandomElement=function(e,t){for(var n,i={distance:0,speed:0},s="shape"+Math.floor(1e3*Math.random());this.newScene[s];)s="shape"+Math.floor(1e3*Math.random());return i.index=s,n=this.pool.borrowShape(),n.x=e.x,n.y=e.y,t?i.distance=e.y-n.height:i.distance=e.y,i.element=n,i},this.getStartCoords=function(){var e=Math.round(this.allowedStartCoords.minX+Math.random()*(this.allowedStartCoords.maxX-this.allowedStartCoords.minX)),t=0;return{x:e,y:t}}};SceneModel.prototype.updateModel=function(e){for(var t in this.newScene)this.newScene[t].distance>this.fieldSize.height+this.newScene[t].element.height?(this.pool.returnShape(this.newScene[t].element),delete this.newScene[t]):(this.newScene[t].speed+=e*this.acceleration,this.newScene[t].distance+=this.newScene[t].speed+this.acceleration*e*e/2);if(this.counterToCreate>1/this.numberOfShapes){var n=this.createRandomElement(this.getStartCoords(),!0);this.newScene[n.index]=n,this.counterToCreate=0}else this.counterToCreate+=e;if(null!=this.createNewElementCoords){var n=this.createRandomElement(this.createNewElementCoords);this.newScene[n.index]=n,this.createNewElementCoords=null}return null!=this.indexToDestroy&&this.newScene[this.indexToDestroy]&&(this.pool.returnShape(this.newScene[this.indexToDestroy].element),delete this.newScene[this.indexToDestroy],this.indexToDestroy=null),this.newScene};var SceneController=function(e,t){var n=this;this.sceneView=e,this.sceneModel=t,this.newScene={},this.ticker=new PIXI.ticker.Ticker,this.update=function(){var e=this.ticker.elapsedMS/1e3;this.newScene=this.sceneModel.updateModel(e),this.sceneView.updateView(this.newScene)};var i=this.sceneModel.setAcceleration(!0,!0),s=this.sceneModel.setNumOfShapes(!0,!0);this.sceneView.setGravity(i),this.sceneView.setShapesPerSec(s),this.sceneView.sendRequestToDestroy=this.destroyElement.bind(this),this.sceneView.sendRequestToCreate=this.createElement.bind(this),this.sceneView.updateGravity=this.updateGravity.bind(this),this.sceneView.updateNumberOfShapes=this.updateSPS.bind(this),window.addEventListener("resize",function(){n.sceneView.resize()}),this.sceneView.resize(),this.ticker.add(this.update,this)};SceneController.prototype.initialize=function(){this.ticker.start()},SceneController.prototype.destroyElement=function(e){this.sceneModel.destroyElement(e)},SceneController.prototype.createElement=function(e){this.sceneModel.setCreateElementFlag(e)},SceneController.prototype.updateGravity=function(e){var t=this.sceneModel.setAcceleration(e,!1);this.sceneView.setGravity(t)},SceneController.prototype.updateSPS=function(e){var t=this.sceneModel.setNumOfShapes(e,!1);this.sceneView.setShapesPerSec(t)};var sceneView=new SceneView(800,600),sceneModel=new SceneModel,sceneController=new SceneController(sceneView,sceneModel);sceneController.initialize();